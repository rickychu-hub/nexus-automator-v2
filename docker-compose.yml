version: '3.8'

services:
  # ðŸ§  "El Cerebro" (FastAPI)
  backend:
    build: ./backend
    container_name: nexus-backend
    ports:
      - "8000:8000"
    volumes:
      # CAMBIO: Ya no apuntamos a './chroma_data_persistent'
      # Ahora apuntamos a un volumen gestionado por Docker llamado 'chroma_data'
      - chroma_data:/data/chroma_db_v2
    env_file:
      - ./backend/.env
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/healthz"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ðŸ‘‹ "El Rostro" (Streamlit)
  frontend:
    build: ./frontend
    container_name: nexus-frontend
    ports:
      - "8501:8501"
    environment:
      - INTERVIEW_URL=http://backend:8000/interview/
      - GENERATION_URL=http://backend:8000/create-workflow-streaming/
    depends_on:
      backend:
        condition: service_healthy
    restart: unless-stopped

    # --- Â¡ESTE ES EL ARREGLO V4.4 QUE FALTA! ---
    volumes:
      - ./frontend/app.py:/app/app.py
    # ---------------------------------------------

  # âœ‹ "Las Manos" (n8n)
  n8n:
    image: n8nio/n8n:latest
    container_name: nexus-n8n
    ports:
      - "5678:5678"
    env_file:
      - ./n8n/.env
    volumes:
      - n8n_data:/home/node/.n8n
    restart: unless-stopped
      
  # ðŸš› "El Suministro" (Script de carga)
  data-pipeline:
    build: ./data_pipeline
    container_name: nexus-data-pipeline
    volumes:
      # CAMBIO: Apuntamos al mismo volumen 'chroma_data'
      - chroma_data:/data/chroma_db_v2
    env_file:
      - ./data_pipeline/.env

# CAMBIO: Definimos nuestros volÃºmenes gestionados por Docker
volumes:
  n8n_data:
    driver: local
  chroma_data: # <-- Â¡AquÃ­ estÃ¡!
    driver: local